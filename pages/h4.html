<!DOCTYPE html>
<html lang="fi">
<head>
    <title>Linux-palvelimet</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/index.css">
</head>
<body>
    <header>
        <h2>Linux-palvelimet <br>Harjoitus 4</h2>
        <p>Kristian Koponen</p>
    </header>
    <div class="navBar">
        <ul>
            <li><a href="h1.html"><b>Harjoitus 1</b><br>Livetikku ja Linuxin testaus</a></li>
            <li><a href="h2.html"><b>Harjoitus 2</b><br>Lokimuutoksia, SSH-demoni ja apt-get</a></li>
            <li><a href="h3.html"><b>Harjoitus 3</b><br>Apache2 asennus, testailu ja lokin tarkastelu</a></li>
            <li><a class="active" href="h4.html"><b>Harjoitus 4</b><br>Virtuaalipalvelin ja nimipalvelu</a></li>
            <li><p>Harjoitus 5</p></li>
            <li><p>Harjoitus 6</p></li>
            <li><p>Harjoitus 7</p></li>
        </ul>
    </div>
    <div class="content">
        <h2>Virtuaalipalvelin ja nimipalvelu</h2>
        <span>22.02.-20, Kristian Koponen</span>
        <div class="blueBox">
            <h3>Tehtävänanto<br><span class="small"><a href="http://terokarvinen.com/2020/linux-palvelimet-2020-alkukevat-kurssi-ict4tn021-3010/#h4">Linux-palvelimet h4</a></span></h3>
            <ul>
                <li>
                    <a href="h4.html#h4a">Uusi virtuaalipalvelin</a>
                </li>
                <li>
                    <a href="h4.html#h4b">Palvelimelle tarvittavat alkutoimet</a>
                </li>
                <li>
                    <a href="h4.html#h4c">DNS-nimi</a>
                </li>
                <li>
                    <a href="h4.html#h4d">TLS-salakirjoitus</a>
                </li>
                <li>
                    <a href="h4.html#h4e">Murtautumisyrityksien tutkimista.</a>
                </li>
            </ul>
        </div>
        <div class="blueBox">
            <h3>Käytetyt laitteet</h3>
            <p class="bold">Lenovo ThinkPad X220</p>
            <table>
                <tr>
                    <th>Prosessori:</th>
                    <th>Intel(R) Core(TM) i5-2540M @ 2.60Ghz</th>
                </tr>
                <tr>
                    <th>Keskusmuisti:</th>
                    <th>4GiB 1333Mhz DDR3</th>
                </tr>
                <tr>
                    <th>Näytönohjain:</th>
                    <th>Intel HD Graphics 3000</th>
                </tr>
                <tr>
                    <th>Käyttöjärjestelmä:</th>
                    <th>Windows 10 64-bit</th>
                </tr>
            </table>
            <p class="bold">SanDisk Ultra USB 3.0 32 GB</p><span>xubuntu 18.04.3 amd64 -live</span><br><br>
        </div>
        <div class="blueBox">
            <h3 id="h4a">Oma julkisen palvelimen tilaaminen</h3>
            <p>Haen julkisen palvelun <a href="https://www.digitalocean.com/">DigitalOcean.com</a> :sta. Ensin kirjaudutaan DigitalOcean.com -palveluun sisälle ja klikataan "New Project". Annetaan projektille nimi, kuvaus ja kerrotaan DigitalOceanille mihin käyttöön tämä tulee.</p>
            <a href="../img/h4/h4img1.jpg"><img src="../img/h4/h4img1.jpg"></a><br>
            <p>Koska minulla on jo DigitalOceanissa yksi projekti, käyttöliittymä kysyy halutaanko siirtää resursseja uuteen projektiin. Ei tällä kertaa, sillä tarkoitus on aloittaa alusta. Skip for now.</p>
            <a href="../img/h4/h4img2.jpg"><img src="../img/h4/h4img2.jpg"></a><br><br>
            <p>Aukeaa projektin etusivu, jossa on eri vaihtoehtoja droplettejen luontiin esim. tietokantamielessä. Klikataan "Get Started with a Droplet". Dropletin luonnissa on erilaisia valintoja.</p>
            <p>Ensimmäisenä valitaan käyttöjärjestelmän levykuva. Ubuntu on tutuin, joten valitaan Ubuntu 18.04.3 (LTS) x64.</p>
            <a href="../img/h4/h4img3.jpg"><img src="../img/h4/h4img3.jpg"></a><br>
            <p>Seuraavaksi valitaan virtuaalipalvelimen suorituskyky ja talletustila. Halvin vaihtoehto löytyy Standard-paketista. (1 GB CPU:lla, 25 GB SSD talletustilalla ja 1000 GB siirtonopeudella. 5 dollaria kuukaudessa.)</p>
            <a href="../img/h4/h4img4.jpg"><img src="../img/h4/h4img4.jpg"></a><br>
            <p>Ei tarvita lisätilaa, joten jätetään block storage kohta tekemättä.</p>
            <a href="../img/h4/h4img5.jpg"><img src="../img/h4/h4img5.jpg"></a><br>
            <p>Palvelimen sijainti valitaan eurooppakeskeisesti Saksasta, joka kuuluu EU-alueeseen.</p>
            <a href="../img/h4/h4img6.jpg"><img src="../img/h4/h4img6.jpg"></a><br>
            <p>Dropletiin voi ottaa lisäpalveluita, kuten yksityinen verkko, IPv6-verkko, käyttäjädata sekä Dropletin seuranta. Ei oteta mitään näistä.</p>
            <a href="../img/h4/h4img7.jpg"><img src="../img/h4/h4img7.jpg"></a><br><br>
            <p>Autentikointi Dropletiin. SSH-avainautentikoinnissa salasanat ovat poissa käytöstä, jolloin Droplet on suojattu brute-force hyökkäyksiä vastaan. Valitaan kuitenkin "One-time password" vaihtoehdon, jolloin DigitalOcean lähettää ennalta määritettyyn sähköpostiosoitteeseen root-käyttäjän salasanan, joka on vaihdettava heti.</p>
            <a href="../img/h4/h4img8.jpg"><img src="../img/h4/h4img8.jpg"></a><br>
            <p>Lopuksi voidaan määritellä montako dropletia luodaan, lisätä hakusanoja niiden organisointia varten ja valita projekti mihin droplet liitetään. Luodaan yksi dropletin ja liitetään se aiemmin luotuun harjoitusprojektiin.</p>
            <a href="../img/h4/h4img9.jpg"><img src="../img/h4/h4img9.jpg"></a><br>
            <p>Ei haluta maksaa varmuuskopioinnista, sillä voimme tehdä sen itse. "Create Droplet."</p>
            <a href="../img/h4/h4img10.jpg"><img src="../img/h4/h4img10.jpg"></a><br>
            <p>Menee hetki virtuaalipalvelimen luonnissa. Palvelin on luotu ja saamme sen IP-osoitteen. Voidaan nyt ottaa SSH-yhteyden palvelimeen.</p>
        </div>
        <div class="blueBox">
            <h3 id="h4b">Palvelimelle tarvittavat alkutoimet</h3>
            <p>
                Aloitetaan avaamalla Linux-päätelaite ja päivittämällä komennolla <span class="command">sudo apt-get update && sudo apt-get upgrade</span>. Asennetaan SSH-demoni komennolla <span class="command">sudo apt-get install ssh -y</span>.
            </p>
            <p>
                Kirjaudutaan palvelimelle SSH-yhteydellä palvelimen IP-osoitteeseen sen root-käyttäjällä. IP-osoitteen saa DigitalOceanin dropletin tiedoista ja root-käyttäjän salasana on lähetetty sähköpostiin. <span class="command">ssh root@10.0.0.1</span>. (Kirjoitin tässä vaiheessa IP-osoitteen väärin ja SSH-yhteys ei onnistunut. Korjasin ongelman kirjoittamalla IP-osoitteen oikein.) Tulee ilmoitus että kyseisen IP-osoitteen autentikointi ei onnistu ja annetaan ECDSA tunniste. Vaihtoehtoina jatkaa tai peruuttaa yhteys. Jatketaan kirjoittamalla <span class="command">yes</span>. Annetaan DigitalOceanin lähettämä salasana, jolla kirjaudumme root-käyttäjälle. Järjestelmä pyytää vaihtamaan salasanan uuteen. Kun olemme tämän tehneet, olemme sisällä uudella palvelimellamme root-käyttäjänä.
            </p>
            <p>
                Ensimmäisenä luomme reiän SSH-yhteydelle (portti 22) palomuuriin, jotta voimme jatkaa käyttöä sen käynnistämisen jälkeen. Komento <span class="command">sudo ufw allow 22/tcp</span>. Käynnistetään palomuuri komennolla <span class="command">sudo ufw enable</span>. Tulee vielä varoitus, että palomuurin käynnistäminen saattaa häiritä nykyistä SSH-yhteyttä. Jatketaan.
            </p>
            <a href="../img/h4/h4img11.jpg"><img src="../img/h4/h4img11.jpg"></a><br>
            <p>
                Luodaan uusi käyttäjä, jotta voimme lukita root-käyttäjän. Komento <span class="command">sudo adduser username</span>. Järjestelmä pyytää asettamaan käyttäjälle salasanan. Käytetään samaa, jota käytimme root-tunnukseen. Seuraavaksi tulee käyttäjälle tietojen asetus. Nimi, huonenumero, puhelinnumero ja muut tiedot. Annetaan käyttäjälle myös pääkäyttäjän, sekä adminin oikeudet.
            </p>
            <a href="../img/h4/h4img12.jpg"><img src="../img/h4/h4img12.jpg"></a><br>
            <p>
                Testataan että käyttäjä toimii. Avataan uusi terminaali ja kirjaudutaan käyttäjällä palvelimelle. Yhteys toimii. Katsotaan vielä käyttäjän ryhmät komennolla <span class="command">groups</span>. Kaikki hyvin.
            </p>
            <a href="../img/h4/h4img13.jpg"><img src="../img/h4/h4img13.jpg"></a><br>
            <p>
                Nyt voidaan lukita root-käyttäjä, ettei sitä voida väärinkäyttää. Ensin lukitaan sen salasana komennolla <span class="command">sudo usermod --lock root</span>. Lukitaan root-käyttäjän SSH-kirjautuminen muokkaamalla /etc/ssh/sshd_config -tiedoston PermitRootLogin kohtaa kirjoittamalla sen perään "no". Komento <span class="command">sudoedit /etc/ssh/sshd_config</span>. Käynnistetään SSH uudelleen.
            </p>
            <a href="../img/h4/h4img14.jpg"><img src="../img/h4/h4img14.jpg"></a><br>
            <p>
                Päivitetään järjestelmä komennolla <span class="command">sudo apt-get update && sudo apt-get upgrade -y</span>. Olemme nyt valmiita palvelimen alkutoimien kanssa.
            </p>
        </div>
        <div class="blueBox">
            <h3 id="h4c">DNS-nimi</h3>
            <p>Haen domain-nimen <a href="https://www.namecheap.com/">NameCheap.com</a> :sta. Olen jo entuudesta luonut tunnuksen ja tilannut domainin, mutta käyn läpi domainin tilauksen vaiheita. Ensin klikataan Domains-välilehti auki ja syötetään hakukenttään haluttu nimi. NameCheap ehdottaa eri päätteitä ja näyttää vuosihinnan niille. Suosituimmat kuten .com ja .net tulevat päällimäisinä mikäli ne ovat vapaita. Lisätään haluttu nimi ostoskoriin. NameCheap tarjoaa ylimääräisiä palveluita lisähinnasta, mutta siirrytään tilaukseen, jossa pyydetään yhteystietoja ja maksutietoja. NameCheapiltä saa ilmaisen WhoisGuard-yksityisyyssuojan, joka estää yhteystietojen näkymisen Whois-palveluissa. Tilauksen voi myös automaattisesti uusia sen päättymisen lähestyessä.</p>
            <a href="../img/h4/h4img15.jpg"><img src="../img/h4/h4img15.jpg"></a><br>
            <p>Kun nimi on tilattu, mennään omalle Dashboardille ja painetaan "Manage" kyseisen nimen kohdalta. Täällä osoitteen liittäminen on piilotettu Advanced DNS -välilehden taakse. Täytetään Host Records -kohtaan uudet A Recordit. Toiselle Host-kohtaan "@" ja toiselle muodon vuoksi tehty "www". Aliosoitteita voidaan luoda rajattomasti ilmaiseksi. A Record (A-tietue) tarkoittaa sitä, että nimellä voidaan osoittaa IP-osoitteeseen, joten lisätään palvelimen IP-osoitteen Value-kenttään ja hyväksytään.</p>
            <a href="../img/h4/h4img16.jpg"><img src="../img/h4/h4img16.jpg"></a><br>
            <p>Annetaan hetki uudelle nimelle tulla näkyviin, ja sitten testataan päästäänkö nimellä IP-osoitteeseen. Mennään terminaaliin ja otetaan SSH-yhteys IP-osoitteen sijasta DNS-nimeen. <span class="command">ssh username@example.com</span>. Päästiin onnistuneesti kirjautumaan palvelimelle, joten voidaan päätellä, että uusi nimi on nyt käytössä.</p>
            <a href="../img/h4/h4img17.jpg"><img src="../img/h4/h4img17.jpg"></a><br>
        </div>
        <div class="blueBox">
            <h3 id="h4d">TLS-salakirjoitus</h3>
            <p>Aloitetaan asentamalla palvelimelle apache2 ja saamalla testisivu näkyviin verkon yli. <span class="command">sudo apt-get install apache2</span>. Tehdään reikä HTTP-pyynnöille palomuuriin komennolla <span class="command">sudo ufw allow 80/tc</span>. Käydään selaimella aiemmin asetetussa osoitteessa katsomassa, että Apachen testisivu näkyy. Näkyy, joten Apache toimii. Voidaan korvata myös testisivun sisältö komennolla <span class="command">echo "Hello world" | sudo tee /var/www/html/index.html</span></p>
            <p>Luodaan VirtualHost domainille kuten <a href="h3.html#h3h">harjoitus 3:ssa</a> tehtiin.</p>
            <p>TLS-salakirjoitusta varten käytetään <a href="https://letsencrypt.org/">Let's Encryptin</a> ilmaista sertifiointia. Let's Encrypt vaatii sertifikaatin uusimisen 90 vuorokauden välein, joten käytetään <a href="https://certbot.eff.org/">Certbotia</a> tämän automatisoimiseksi.</p>
            <p>Certbotin sivuilta saa palvelimen perusteella suorat <a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-apache">ohjeet</a> Certbotin asentamiselle. Seuraavilla komennoilla saadaan Certbot PPA repositoryyn:</p>
            <ul>
                <li><span class="command">sudo apt-get update</span></li>
                <li><span class="command">sudo apt-get install software-properties-common</span></li>
                <li><span class="command">sudo add-apt-repository universe</span></li>
                <li><span class="command">sudo add-apt-repository ppa:certbot/certbot</span></li>
                <li><span class="command">sudo apt-get update</span></li>
            </ul>
            <p>Asennetaan Certbot komennolla <span class="command">sudo apt-get install certbot python-certbot-apache</span>. Sitten haetaan sertifikaatti ja asennetaan se Apache-palvelimen konfiguraatioon komennolla <span class="command">sudo certbot --apache</span>.</p>
            <p>Certbot pyytää sähköpostiosoitetta uusimis- ja turvallisuustiedoituksia varten, lukemaan käyttöehdot ja hyväksymään ne sekä lupaa jakaa sähköpostiosoitteen Electronic Frontier Foundationin muita tiedotteita varten. Certbot käy läpi Apachen konfiguraatio-tiedostot ja kysyy vielä mille nimille HTTPS halutaan aktivoida. Tässä voidaan valita tietyt nimet, tai jättää kohta tyhjäksi jolloin se aktivoidaan kaikille havaituille sivuille. Vielä täytyy valita halutaanko ohjata HTTP-pyynnöt HTTPS:ää, joka poistaa HTTP-pyynnöt käytöstä. Valitaan tähän kyllä.</p>
            <p>Saadaan vihdoin ilmoitus, että sertifikaatti on käytössä. Testataan automattista uusimista komennolla <span class="command">sudo certbot renew --dry-run</span>. Komentoriville tulostuu uusimisen kuivaharjoittelua ja onnistumisilmoitus. Voidaan nyt vielä käydä testaamassa, että meillä on HTTPS-yhteys. Nyt selaimella osoitteeseen navigoidessa tulee "Connection timed out". Spekuloin virheen johtuvan portista ja palomuuriasetuksista. Otin HTTP:n pois käytöstä, joten nyt yhteyttä yritetään luoda HTTPS:n kautta ja HTTPS käyttää oletusarvoisesti porttia 443. Luodaan siis reikä palomuuriin portille 443 komennolla <span class="command">sudo ufw allow 443/tcp</span>. Kokeillaan uudelleen ja sivu tulee näkyviin ja yhteys näkyy olevan verifioitu.</p>
            <a href="../img/h4/h4img18.jpg"><img src="../img/h4/h4img18.jpg"></a><br>
            <p>Otetaan lopuksi Apachen oletussivu pois käytöstä komennolla <span class="command">sudo a2dissite 000-default.com.conf</span> ja vielä sertifioinnin yhteydessä luotu <span class="command">sudo a2dissite 000-default.com-le-ssl.conf</span>. Käynnistetään Apache uudestaan komennolla <span class="command">sudo systemctl reload apache2</span>.</p>
        </div>
        <div class="blueBox">
            <h3 id="h4e">Murtautumisyrityksien tutkimista</h3>
            <p>Käydään tutkimassa autentikointi-lokia komennolla <span class="command">tail -n 30 /var/log/auth.log</span>. Löytyy useita eri yrityksiä kirjautua root-käyttäjänä sisään. On tullut autentikointi-virhe väärien salasanojen vuoksi. Todennäköisesti yritetään päästä kirjautumaan sisään sanakirjahyökkäyksellä.
            </p>
            <a href="../img/h4/h4img19.jpg"><img src="../img/h4/h4img19.jpg"></a><br>
            <p>Kirjautumisyrityksessä näkyy IP-osoite, josta yritys on tullut. Katsotaan komennolla <span class="command">whois (IP-osoite)</span> mistä tämä on lähtöisin. Näyttää tulleen kiinalaisen operaattorin hallinoimasta osoitteesta.</p>
            <a href="../img/h4/h4img20.jpg"><img src="../img/h4/h4img20.jpg"></a><br>
            <p>Vaikka root-käyttäjä on palvelimella lukittu, halutaan kuitenkin estää jatkuva SSH-pommitus. Ideana on estää yhteydet useasti epäonnistuneesta kirjautumisyrityksestä.</p>
            <p>Asennetaan fail2ban komennolla <span class="command">sudo apt-get install fail2ban</span>. Tarkastetaan että fail2ban demonia on käynnissä komennolla <span class="command">sudo systemctl status fail2ban</span>. Saadaan konsoliin näkyviin, että fail2ban on aktiivinen ja elinikä. Fail2ban pitää kuitenkin vielä konfiguroida. Vaihdetaan fail2banin hakemistoon <span class="command">cd /etc/fail2ban</span>. Fail2ban lukee ensin .conf tiedostot ja sen jälkeen .local tiedostot, eli muutokset on hyvä tehdä .local tiedostoon. Kopioidaan jail.conf tiedosto komennolla <span class="command">sudo cp jail.conf jail.local</span>.</p>
            <p>Tässä tiedostossa muutetaan "bantime", "findtime" ja "maxretry" kohtia. Laitetaan eston pituudeksi testimielessä 3 minuuttia. Eli 180 kohdan "bantime" perään. Jätetään "findtime" ja "bantime" vielä oletusarvoihin. Eli jos tulee 5 epäonnistunutta kirjautumisyritystä 10 minuutin sisällä, tulee 3 minuutin esto. Tällä on hyvä testata. Voidaan myöhemmin muuttaa näitä arvoja sopivimmiksi.</p>
            <p>Mennään tiedostossa alaspäin kohtaan "# JAILS". Lisätään kohdan "[sshd]" perään "enable = true" ja muutetaan "port" kohtaan käytetty SSH-portti (oletusarvoisesti 22). Tallennetaan tiedosto ja käynnistetään Fail2ban uudelleen komennolla <span class="command">sudo systemctl restart fail2ban</span>.</p>
            <p>Jäädään lukemaan fail2ban lokia komennolla <span class="command">tail -f /var/log/fail2ban.log</span>. Tarkoituksena oli koittaa kirjautua itse väärillä tunnuksilla, mutta botit ehtivätkin ensin ja lokiin tallentui useita yrityksiä. Jokainen osoite estettiin viiden yrityksen jälkeen kolmeksi minuutiksi.</p>
            <a href="../img/h4/h4img21.jpg"><img src="../img/h4/h4img21.jpg"></a><br>
            <p>Testasin vielä kuitenkin itse mitä tapahtuu, kun kirjautuu väärillä tunnuksilla, eri IP:stä ettei oma yhteys katkea. Yhteys ei yksinkertaisesti onnistu ollenkaan. Tästä testistä päättelin, että fail2ban toimii. Mennään muokkaamaan "bantime", "findtime" ja "maxretry" kohdat /etc/fail2ban/jail.local -tiedostosta sopiviksi ja jätetään fail2ban hoitamaan tunkeilijat.</p>
        </div>  
        <div class="blueBox">
            <h3>Lähteet</h3>
            <p>
                <a href="http://terokarvinen.com/2020/linux-palvelimet-2020-alkukevat-kurssi-ict4tn021-3010/#h4">http://terokarvinen.com/2020/linux-palvelimet-2020-alkukevat-kurssi-ict4tn021-3010/#h4</a><br>
                <a href="http://terokarvinen.com/2017/first-steps-on-a-new-virtual-private-server-an-example-on-digitalocean">http://terokarvinen.com/2017/first-steps-on-a-new-virtual-private-server-an-example-on-digitalocean</a><br>
                <a href="https://letsencrypt.org/">https://letsencrypt.org/</a><br>
                <a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-apache">https://certbot.eff.org/lets-encrypt/ubuntubionic-apache</a><br>
                <a href="https://withblue.ink/2016/07/15/stop-ssh-brute-force-attempts.html">https://withblue.ink/2016/07/15/stop-ssh-brute-force-attempts.html</a><br>
                <a href="https://www.fail2ban.org/wiki/index.php/Main_Page">https://www.fail2ban.org/wiki/index.php/Main_Page</a><br>
                
            </p>
        </div>
    </div>
</body>
</html>